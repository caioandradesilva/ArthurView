# Firebase Database Schema Changes for Maintenance System

## Overview
This document outlines all the new collections and fields that need to be created in Firebase Firestore for the Maintenance Management System.

---

## New Collections to Create

### 1. Collection: `maintenanceTickets`

**Purpose**: Store maintenance request tickets with detailed work tracking

**Fields**:
```
{
  // Auto-generated by Firebase
  id: string (document ID)

  // Basic Information
  ticketNumber: number,              // Sequential maintenance ticket number (e.g., 5001, 5002)
  title: string,                     // Brief description of maintenance
  description: string,               // Detailed description

  // Maintenance Classification
  maintenanceType: string,           // "preventive" | "corrective" | "predictive" | "inspection" | "upgrade"
  priority: string,                  // "low" | "medium" | "high" | "urgent"
  status: string,                    // "scheduled" | "pending_approval" | "approved" | "dispatched" | "in_progress" | "awaiting_parts" | "completed" | "verified" | "closed"

  // Asset Reference
  assetType: string,                 // "site" | "container" | "rack" | "asic"
  assetId: string,                   // ID of the referenced asset
  siteId: string,                    // For access control

  // Scheduling
  scheduledDate: timestamp,          // When maintenance is scheduled to occur
  estimatedDuration: number,         // Estimated hours to complete

  // Assignment
  createdBy: string,                 // Who created the request
  createdByRole: string,             // "operator" | "admin" | "client"
  assignedTo: array<string>,         // Array of operator names
  approvedBy: string,                // Operator who approved to start work
  approvedAt: timestamp,             // When work was approved to start

  // Work Tracking
  workStartedAt: timestamp,          // When operator started work
  workCompletedAt: timestamp,        // When operator completed work
  workPerformed: string,             // Detailed log of work performed
  laborHours: number,                // Total hours worked

  // Parts and Materials
  partsUsed: array<object>,          // Array of {partName, quantity, partNumber, cost}

  // Verification
  verifiedBy: string,                // Admin who verified completion
  verifiedAt: timestamp,             // When work was verified
  verificationNotes: string,         // Admin notes on verification

  // Costs
  estimatedCost: number,
  actualCost: number,
  costCurrency: string,              // "USD" | "BRL"

  // Flags
  isUrgent: boolean,                 // Emergency maintenance
  isRecurring: boolean,              // Part of recurring schedule
  recurringScheduleId: string,       // Reference to maintenance schedule if recurring

  // Visibility
  clientVisible: boolean,            // Whether client can see this

  // Timestamps
  createdAt: timestamp,
  updatedAt: timestamp,
  closedAt: timestamp
}
```

**Indexes Required**:
- `siteId` + `status` + `createdAt` (descending)
- `assignedTo` (array-contains) + `status` + `createdAt` (descending)
- `maintenanceType` + `status` + `scheduledDate`
- `ticketNumber` (descending)

---

### 2. Collection: `maintenanceAttachments`

**Purpose**: Store images and documents for maintenance tickets

**Fields**:
```
{
  id: string (document ID),

  maintenanceTicketId: string,      // Reference to maintenance ticket

  // File Information
  fileName: string,
  fileUrl: string,                   // Firebase Storage URL
  fileType: string,                  // "image" | "document" | "video"
  fileSize: number,                  // In bytes
  mimeType: string,                  // e.g., "image/jpeg"

  // Metadata
  category: string,                  // "before" | "during" | "after" | "parts" | "other"
  description: string,               // Optional description

  // Tracking
  uploadedBy: string,
  uploadedAt: timestamp,

  createdAt: timestamp
}
```

**Indexes Required**:
- `maintenanceTicketId` + `category` + `createdAt`

---

### 3. Collection: `maintenanceSchedules`

**Purpose**: Store recurring preventive maintenance schedules

**Fields**:
```
{
  id: string (document ID),

  // Schedule Information
  name: string,                      // e.g., "Monthly ASIC Inspection"
  description: string,

  // Asset Reference
  assetType: string,                 // "site" | "container" | "rack" | "asic"
  assetId: string,                   // ID of asset or "all" for all assets of type
  siteId: string,

  // Schedule Configuration
  maintenanceType: string,           // Usually "preventive" or "inspection"
  frequency: string,                 // "daily" | "weekly" | "monthly" | "quarterly" | "yearly"
  frequencyValue: number,            // e.g., every 2 weeks = 2

  // Timing
  startDate: timestamp,              // When schedule starts
  endDate: timestamp,                // Optional end date
  nextScheduledDate: timestamp,      // Next occurrence
  lastGeneratedDate: timestamp,      // Last time ticket was auto-generated

  // Template for Generated Tickets
  ticketTemplate: object {
    title: string,
    description: string,
    priority: string,
    estimatedDuration: number,
    assignedTo: array<string>
  },

  // Status
  isActive: boolean,

  // Tracking
  createdBy: string,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

**Indexes Required**:
- `isActive` + `nextScheduledDate`
- `assetId` + `isActive`

---

### 4. Collection: `maintenanceParts`

**Purpose**: Track parts inventory for maintenance

**Fields**:
```
{
  id: string (document ID),

  // Part Information
  partNumber: string,                // Manufacturer part number
  partName: string,                  // Descriptive name
  description: string,
  category: string,                  // "power_supply" | "fan" | "board" | "cable" | "other"

  // Inventory
  quantityAvailable: number,
  quantityReserved: number,          // Reserved for scheduled maintenance
  reorderLevel: number,              // Minimum quantity before reorder
  reorderQuantity: number,           // How many to order when reordering

  // Costs
  unitCost: number,
  currency: string,                  // "USD" | "BRL"

  // Location
  siteId: string,                    // Where part is stored
  location: string,                  // Specific location in site

  // Supplier
  supplierName: string,
  supplierPartNumber: string,
  leadTimeDays: number,

  // Tracking
  createdBy: string,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

**Indexes Required**:
- `siteId` + `category`
- `partNumber`

---

### 5. Collection: `maintenanceComments`

**Purpose**: Store comments and notes on maintenance tickets (separate from regular ticket comments)

**Fields**:
```
{
  id: string (document ID),

  maintenanceTicketId: string,

  message: string,
  commentType: string,               // "note" | "status_update" | "escalation" | "verification"

  author: string,
  authorRole: string,                // "operator" | "admin" | "client"

  // Attachments
  hasAttachments: boolean,
  attachmentIds: array<string>,      // References to maintenanceAttachments

  createdAt: timestamp
}
```

**Indexes Required**:
- `maintenanceTicketId` + `createdAt`

---

### 6. Collection: `maintenanceAuditEvents`

**Purpose**: Track all changes and events in maintenance system

**Fields**:
```
{
  id: string (document ID),

  maintenanceTicketId: string,

  eventType: string,                 // "created" | "status_changed" | "assigned" | "approved" | "started" | "completed" | "verified" | "part_added" | "attachment_added" | "comment_added"
  description: string,

  performedBy: string,
  performedByRole: string,

  // Change Details
  previousValue: string,             // Optional: previous state
  newValue: string,                  // Optional: new state

  metadata: object,                  // Additional context data

  createdAt: timestamp
}
```

**Indexes Required**:
- `maintenanceTicketId` + `createdAt` (descending)

---

## Updates to Existing Collections

### Collection: `asics`

**Add New Fields**:
```
{
  // Existing fields remain...

  // Add these new fields:
  lastMaintenanceDate: timestamp,    // Last completed maintenance
  nextMaintenanceDate: timestamp,    // Next scheduled maintenance
  maintenanceScheduleId: string,     // Reference to active maintenance schedule
  totalMaintenanceHours: number,     // Lifetime maintenance hours
  maintenanceCount: number           // Total number of maintenance performed
}
```

---

## Firebase Storage Buckets

### Create Storage Path Structure:
```
/maintenance-attachments/
  /{maintenanceTicketId}/
    /before/
      {filename}
    /during/
      {filename}
    /after/
      {filename}
    /parts/
      {filename}
    /other/
      {filename}
```

---

## Security Rules Recommendations

```javascript
// Add to your Firestore security rules:

// Maintenance Tickets
match /maintenanceTickets/{ticketId} {
  allow read: if request.auth != null;
  allow create: if request.auth != null;
  allow update: if request.auth != null;
  allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}

// Maintenance Attachments
match /maintenanceAttachments/{attachmentId} {
  allow read: if request.auth != null;
  allow create: if request.auth != null;
  allow delete: if request.auth != null;
}

// Maintenance Schedules
match /maintenanceSchedules/{scheduleId} {
  allow read: if request.auth != null;
  allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'operator'];
  allow update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'operator'];
  allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}

// Maintenance Parts
match /maintenanceParts/{partId} {
  allow read: if request.auth != null;
  allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'operator'];
}

// Maintenance Comments
match /maintenanceComments/{commentId} {
  allow read: if request.auth != null;
  allow create: if request.auth != null;
  allow update: if request.auth.uid == resource.data.authorId;
  allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}

// Maintenance Audit Events
match /maintenanceAuditEvents/{eventId} {
  allow read: if request.auth != null;
  allow create: if request.auth != null;
  allow update, delete: if false; // Audit events are immutable
}
```

---

## Firebase Storage Security Rules

```javascript
// Add to your Firebase Storage security rules:

service firebase.storage {
  match /b/{bucket}/o {
    match /maintenance-attachments/{maintenanceTicketId}/{category}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null
                   && request.resource.size < 10 * 1024 * 1024  // 10MB limit
                   && request.resource.contentType.matches('image/.*|application/pdf|video/.*');
    }
  }
}
```

---

## Initial Data Setup

### Create a counter document for maintenance ticket numbers:

**Collection**: `counters`
**Document ID**: `maintenanceTicket`
```
{
  lastTicketNumber: 5000  // Start maintenance tickets at 5001
}
```

---

## Migration Notes

1. **No existing data migration needed** - This is all new functionality
2. **ASICs collection** - The new fields added to ASICs will be automatically created when maintenance is performed
3. **Users collection** - No changes needed, existing role field is sufficient
4. **Indexes** - Create these through Firebase Console as queries fail and Firebase provides index creation links
5. **Testing** - Create test maintenance tickets to verify all indexes are properly created

---

## Implementation Order

1. Create `counters` collection with `maintenanceTicket` document
2. Create all 6 new collections (they can be empty initially)
3. Set up Firebase Storage bucket structure
4. Add security rules for new collections
5. Test with the application (indexes will be created automatically when needed)
6. Update existing `asics` documents with new fields as maintenance is performed

---

## Questions or Changes Needed?

Please review this schema and let me know if you need any adjustments before I proceed with the code implementation.
